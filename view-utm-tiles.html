<!DOCTYPE html>
<html>
<head>
    <title>Madrid UTM Tiles Viewer</title>
    <script src='https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: monospace;
            z-index: 1;
        }
        #coords {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <div id='info'>
        <h3 style="margin-top: 0;">Madrid UTM Zone 30</h3>
        <div>EPSG:32630</div>
        <div>1 unit = 1 meter</div>
        <hr>
        <div id="layers">Loading layers...</div>
    </div>
    <div id='coords'>
        <div>UTM: <span id="utm">-</span></div>
        <div>Lat/Lng: <span id="latlng">-</span></div>
    </div>

    <script>
        // Register PMTiles protocol
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'madrid-utm': {
                        type: 'vector',
                        url: 'pmtiles://http://localhost:8080/madrid_utm30.pmtiles'
                    },
                    // Fallback OSM for reference
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '© OpenStreetMap'
                    }
                },
                layers: [
                    {
                        id: 'osm-base',
                        type: 'raster',
                        source: 'osm',
                        paint: { 'raster-opacity': 0.3 }
                    },
                    {
                        id: 'buildings',
                        type: 'fill',
                        source: 'madrid-utm',
                        'source-layer': 'buildings',
                        paint: {
                            'fill-color': '#d4d4d4',
                            'fill-outline-color': '#999'
                        }
                    },
                    {
                        id: 'roads',
                        type: 'line',
                        source: 'madrid-utm',
                        'source-layer': 'roads',
                        paint: {
                            'line-color': '#ff6600',
                            'line-width': 2
                        }
                    },
                    {
                        id: 'road-labels',
                        type: 'symbol',
                        source: 'madrid-utm',
                        'source-layer': 'roads',
                        layout: {
                            'text-field': '{name}',
                            'text-font': ['Open Sans Regular'],
                            'text-size': 12,
                            'symbol-placement': 'line'
                        },
                        paint: {
                            'text-color': '#333',
                            'text-halo-color': '#fff',
                            'text-halo-width': 2
                        }
                    },
                    {
                        id: 'parks',
                        type: 'fill',
                        source: 'madrid-utm',
                        'source-layer': 'parks',
                        paint: {
                            'fill-color': '#90ee90',
                            'fill-opacity': 0.5
                        }
                    },
                    {
                        id: 'places',
                        type: 'symbol',
                        source: 'madrid-utm',
                        'source-layer': 'places',
                        layout: {
                            'text-field': '{name}',
                            'text-size': 10,
                            'text-anchor': 'center'
                        },
                        paint: {
                            'text-color': '#000',
                            'text-halo-color': '#fff',
                            'text-halo-width': 1
                        }
                    }
                ]
            },
            center: [-3.7038, 40.4168], // Madrid center
            zoom: 14
        });

        // Add navigation control
        map.addControl(new maplibregl.NavigationControl());

        // Show coordinates
        map.on('mousemove', (e) => {
            // Convert to UTM (approximate)
            const utm_e = 440000 + (e.lngLat.lng + 3.7) * 85000;
            const utm_n = 4474000 + (e.lngLat.lat - 40.4) * 111000;
            
            document.getElementById('utm').textContent = 
                `E: ${utm_e.toFixed(0)}m, N: ${utm_n.toFixed(0)}m`;
            document.getElementById('latlng').textContent = 
                `${e.lngLat.lat.toFixed(5)}, ${e.lngLat.lng.toFixed(5)}`;
        });

        // Check what layers are available
        map.on('load', () => {
            const layers = map.getStyle().layers
                .filter(l => l.source === 'madrid-utm')
                .map(l => `✓ ${l.id}`)
                .join('<br>');
            document.getElementById('layers').innerHTML = layers || 'No layers found';
        });
    </script>
</body>
</html>